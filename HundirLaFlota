using System;
using System.Collections.Generic;

class Barco
{
    public int Tamaño { get; private set; }
    public List<(int fila, int columna)> Posiciones { get; private set; }
    public bool OrientacionHorizontal { get; private set; }
    private int impactos;

    public Barco(int tamaño)
    {
        Tamaño = tamaño;
        Posiciones = new List<(int, int)>();
        impactos = 0;
    }

    public void ColocarEn(int filaInicial, int columnaInicial, bool horizontal)
    {
        OrientacionHorizontal = horizontal;
        Posiciones.Clear();

        for (int i = 0; i < Tamaño; i++)
        {
            if (horizontal)
                Posiciones.Add((filaInicial, columnaInicial + i));
            else
                Posiciones.Add((filaInicial + i, columnaInicial));
        }
    }

    public bool EstaEnPosicion(int fila, int columna)
    {
        foreach (var pos in Posiciones)
            if (pos.fila == fila && pos.columna == columna)
                return true;
        return false;
    }

    public bool RecibirImpacto(int fila, int columna)
    {
        if (EstaEnPosicion(fila, columna))
        {
            impactos++;
            return true;
        }
        return false;
    }

    public bool EstaHundido()
    {
        return impactos >= Tamaño;
    }
}

class Tablero
{
    private const int tamaño = 15;
    private char[,] celdas = new char[tamaño, tamaño];
    public List<Barco> Barcos { get; private set; } = new List<Barco>();

    public Tablero()
    {
        for (int i = 0; i < tamaño; i++)
            for (int j = 0; j < tamaño; j++)
                celdas[i, j] = '~'; // agua
    }

    public bool PuedeColocarBarco(Barco barco, int fila, int columna, bool horizontal)
    {
        if (horizontal && columna + barco.Tamaño > tamaño) return false;
        if (!horizontal && fila + barco.Tamaño > tamaño) return false;

        for (int i = 0; i < barco.Tamaño; i++)
        {
            int f = horizontal ? fila : fila + i;
            int c = horizontal ? columna + i : columna;
            if (celdas[f, c] != '~') return false;
        }
        return true;
    }

    public void ColocarBarco(Barco barco, int fila, int columna, bool horizontal)
    {
        if (!PuedeColocarBarco(barco, fila, columna, horizontal))
            throw new Exception("No se puede colocar el barco aquí.");

        barco.ColocarEn(fila, columna, horizontal);
        Barcos.Add(barco);

        foreach (var (f, c) in barco.Posiciones)
            celdas[f, c] = 'B';
    }

    public bool Disparar(int fila, int columna)
    {
        if (celdas[fila, columna] == 'X' || celdas[fila, columna] == 'O')
            return false; // ya disparado

        foreach (var barco in Barcos)
        {
            if (barco.RecibirImpacto(fila, columna))
            {
                celdas[fila, columna] = 'X'; // impacto
                return true;
            }
        }

        celdas[fila, columna] = 'O'; // agua
        return false;
    }

    public bool TodosHundidos()
    {
        foreach (var b in Barcos)
            if (!b.EstaHundido())
                return false;
        return true;
    }

    public void MostrarTablero()
    {
        for (int i = 0; i < tamaño; i++)
        {
            for (int j = 0; j < tamaño; j++)
                Console.Write(celdas[i, j] + " ");
            Console.WriteLine();
        }
    }
}

class Juego
{
    private Tablero jugador = new Tablero();
    private Tablero cpu = new Tablero();
    private Random random = new Random();

    public void IniciarPartida()
    {
        Console.WriteLine("Colocando barcos del jugador...");
        ColocarBarcosAutomaticamente(jugador);

        Console.WriteLine("Colocando barcos de la CPU...");
        ColocarBarcosAutomaticamente(cpu);

        Console.WriteLine("¡Comienza la partida!");
        BucleJuego();
    }

    private void ColocarBarcosAutomaticamente(Tablero tablero)
    {
        int[] tamaños = { 4, 3, 2, 1, 1 };
        foreach (int t in tamaños)
        {
            bool colocado = false;
            while (!colocado)
            {
                int fila = random.Next(0, 15);
                int columna = random.Next(0, 15);
                bool horizontal = random.Next(0, 2) == 0;
                var barco = new Barco(t);

                if (tablero.PuedeColocarBarco(barco, fila, columna, horizontal))
                {
                    tablero.ColocarBarco(barco, fila, columna, horizontal);
                    colocado = true;
                }
            }
        }
    }

    private void BucleJuego()
    {
        while (true)
        {
            Console.WriteLine("\nTu tablero:");
            jugador.MostrarTablero();
            Console.Write("\nDispara (fila columna): ");
            var partes = Console.ReadLine().Split(' ');
            int fila = int.Parse(partes[0]);
            int columna = int.Parse(partes[1]);

            bool acierto = cpu.Disparar(fila, columna);
            Console.WriteLine(acierto ? "Impacto!" : "Agua...");

            if (cpu.TodosHundidos())
            {
                Console.WriteLine("¡Has ganado!");
                break;
            }

            int fCpu = random.Next(0, 15);
            int cCpu = random.Next(0, 15);
            bool aciertoCpu = jugador.Disparar(fCpu, cCpu);
            Console.WriteLine(aciertoCpu
                ? $"La CPU te ha dado en ({fCpu}, {cCpu})"
                : $"La CPU falló en ({fCpu}, {cCpu})");

            if (jugador.TodosHundidos())
            {
                Console.WriteLine("La CPU gana.");
                break;
            }
        }
    }
}
